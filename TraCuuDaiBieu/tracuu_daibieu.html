<!DOCTYPE html>
<html lang="vi">
  <head>
    <link rel="icon" type="image/png" href="/images/Codang.png">
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Tra cứu Đại biểu Chính thức</title>
    <link rel="stylesheet" href="style.css" />
    <style>
      /* Khi table có class 'an-cot-phu', các cột có class này sẽ bị ẩn đi */
      #delegateTable.an-cot-phu .cot-phu {
        display: none;
      }
    </style>
  </head>

  <body>
    <div class="container">
      <h1>DANH SÁCH ĐẠI BIỂU CHÍNH THỨC</h1>
      <h2>ĐẠI HỘI ĐẠI BIỂU ĐẢNG BỘ TỈNH THÁI NGUYÊN</h2>
      <h2>NHIỆM KỲ 2025 - 2030</h2>

      <div id="filter-tabs"></div>

      <input
        type="text"
        id="searchBox"
        onkeyup="filterTable()"
        placeholder="Nhập tên đại biểu hoặc đơn vị để tìm kiếm..."
      />

      <table id="delegateTable">
        <thead>
          <tr>
            <th rowspan="2">STT</th>
            <th rowspan="2">Họ và Tên</th>
            <th rowspan="2">Đơn vị</th>
            <th colspan="2">Vị trí chỗ ngồi</th>
            <th rowspan="2">Tổ thảo luận</th>
            <th rowspan="2" class="cot-phu">Tên khách sạn</th>
            <th rowspan="2" class="cot-phu">Số phòng</th>
          </tr>
          <tr>
            <th>Phiên khai mạc</th>
            <th>Phiên khác</th>
          </tr>
        </thead>
        <tbody id="tableBody">
          <tr>
            <td colspan="8" style="text-align: center">Đang tải dữ liệu...</td>
          </tr>
        </tbody>
      </table>
    </div>

    <script>
      // Gọi API với type=daibieu
      const apiUrl =        "https://script.google.com/macros/s/AKfycbxtztCEyEd0OIbY6dSQ_iZlQVcT0QONi0I71Vvh3Pd5hXGdA69tzpTA6SnjmNEpc8zCKA/exec?type=daibieu";

      let allDelegates = [];
      const table = document.getElementById("delegateTable"); // <-- Lấy thẻ table
      const tableBody = document.getElementById("tableBody");
      const tabsContainer = document.getElementById("filter-tabs");

      function createFilterTabs() {
          const priorityOrder = [
            "Thường trực Tỉnh ủy",
            "Ủy viên BTV Tỉnh ủy",
            "Đảng bộ các cơ quan Đảng tỉnh",
            "Đảng bộ UBND tỉnh",
            "Đảng bộ Công an",
            "Đảng bộ Quân sự",
            "Xã, phường 1", // Cập nhật tên nhóm chung
            "Xã, phường 2", // Cập nhật tên nhóm chung
            "Xã, phường 3", // Cập nhật tên nhóm chung
            "Xã, phường 4", // Cập nhật tên nhóm chung
          ];

          // ✅ LOGIC MỚI: Tạo nhóm chính bằng cách loại bỏ A/B
          const uniqueMainGroups = [
            ...new Set(
              allDelegates
                .map((d) => {
                  if (d.nhomDonVi) {
                    // Nếu tên nhóm kết thúc bằng A hoặc B, loại bỏ ký tự đó
                    if (/[AB]$/.test(d.nhomDonVi)) {
                      return d.nhomDonVi.slice(0, -1);
                    }
                    return d.nhomDonVi;
                  }
                  return null;
                })
                .filter(Boolean)
            ),
          ];

          uniqueMainGroups.sort((a, b) => {
            const indexA = priorityOrder.indexOf(a);
            const indexB = priorityOrder.indexOf(b);
            const effectiveIndexA = indexA === -1 ? Infinity : indexA;
            const effectiveIndexB = indexB === -1 ? Infinity : indexB;

            if (effectiveIndexA !== effectiveIndexB) {
              return effectiveIndexA - effectiveIndexB;
            }
            return a.localeCompare(b, "vi");
          });

          tabsContainer.innerHTML = "";
          const allButton = document.createElement("button");
          allButton.className = "filter-btn active";
          allButton.innerText = "Tất cả";
          allButton.onclick = () => displayDelegates("Tất cả");
          tabsContainer.appendChild(allButton);

          uniqueMainGroups.forEach((unit) => {
            const unitButton = document.createElement("button");
            unitButton.className = "filter-btn";
            unitButton.innerText = unit;
            unitButton.onclick = () => displayDelegates(unit);
            tabsContainer.appendChild(unitButton);
          });
      }

      // =================================================================
      // HÀM DISPLAYDELEGATES ĐÃ ĐƯỢC CẬP NHẬT
      // =================================================================
      function displayDelegates(unitFilter) {
          const groupsToHideFor = ["Thường trực Tỉnh ủy", "Ủy viên BTV Tỉnh ủy"];
          const shouldHideColumns = groupsToHideFor.includes(unitFilter);

          table.classList.toggle("an-cot-phu", shouldHideColumns);
          const colspanValue = shouldHideColumns ? 6 : 8;

          tableBody.innerHTML = "";

          // ✅ LOGIC MỚI: Lọc theo tên nhóm chung
          const delegatesToDisplay =
            unitFilter === "Tất cả"
              ? allDelegates
              : allDelegates.filter((d) => d.nhomDonVi && d.nhomDonVi.startsWith(unitFilter));

          document.querySelectorAll(".filter-btn").forEach((btn) => {
            btn.classList.toggle("active", btn.innerText === unitFilter);
          });

          if (delegatesToDisplay.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="${colspanValue}" style="text-align:center;">Không có đại biểu nào.</td></tr>`;
            return;
          }

          delegatesToDisplay.forEach((delegate, index) => {
            const sttDisplay = unitFilter === "Tất cả" ? delegate.stt : index + 1;
            const newRow = document.createElement("tr");

            newRow.innerHTML = `
                    <td class="text-center">${sttDisplay}</td>
                    <td>${delegate.hoTen}</td>
                    <td>${delegate.donVi}</td>
                    <td class="text-center">${delegate.viTriKhaiMac || ""}</td>
                    <td class="text-center">${delegate.viTriPhienKhac || ""}</td>
                    <td class="text-center">${delegate.toThaoLuan || ""}</td>
                    <td class="cot-phu">${delegate.khachSan || ""}</td>
                    <td class="cot-phu text-center">${delegate.soPhong || ""}</td>
                  `;
            tableBody.appendChild(newRow);
          });

          document.getElementById("searchBox").value = "";
          filterTable();
      }
      // =================================================================

      function filterTable() {
        const input = document.getElementById("searchBox");
        const filter = input.value.toUpperCase();
        const tr = tableBody.getElementsByTagName("tr");

        for (let i = 0; i < tr.length; i++) {
          const tdName = tr[i].getElementsByTagName("td")[1];
          const tdUnit = tr[i].getElementsByTagName("td")[2];

          if (tdName || tdUnit) {
            const nameText = tdName.textContent || tdName.innerText;
            const unitText = tdUnit.textContent || tdUnit.innerText;

            if (
              nameText.toUpperCase().indexOf(filter) > -1 ||
              unitText.toUpperCase().indexOf(filter) > -1
            ) {
              tr[i].style.display = "";
            } else {
              tr[i].style.display = "none";
            }
          }
        }
      }

      // Cập nhật colspan trong các hàm fetch
      const initialColspan = 8;
      fetch(apiUrl)
        .then((response) => {
          if (!response.ok) {
            throw new Error("Lỗi mạng hoặc không gọi được API");
          }
          return response.json();
        })
        .then((data) => {
          if (data && data.delegates) {
            allDelegates = data.delegates;
            createFilterTabs();
            displayDelegates("Tất cả");
          } else {
            tableBody.innerHTML = `<tr><td colspan="${initialColspan}" style="text-align:center; color:red;">Dữ liệu nhận được không đúng định dạng.</td></tr>`;
          }
        })
        .catch((error) => {
          console.error("Lỗi khi tải dữ liệu:", error);
          tableBody.innerHTML = `<tr><td colspan="${initialColspan}" style="text-align:center; color:red;">Không thể tải dữ liệu. Vui lòng kiểm tra lại URL hoặc cài đặt API.</td></tr>`;
        });
    </script>

    <a href="../index.html" class="home-button" title="Về Trang chủ">
      <svg
        xmlns="http://www.w3.org/2000/svg"
        viewBox="0 0 24 24"
        fill="currentColor"
        width="24"
        height="24"
      >
        <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8h5z" />
      </svg>
      <span>Về Trang chủ</span>
    </a>
  </body>
</html>