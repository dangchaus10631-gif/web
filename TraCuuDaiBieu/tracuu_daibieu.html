<!DOCTYPE html>
<html lang="vi">
  <head>
    <link rel="icon" type="image/png" href="/images/Codang.png" />
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Tra cứu Đại biểu Chính thức</title>
    <link rel="stylesheet" href="style.css" />
    <style>
      /* Khi table có class 'an-cot-phu', các cột có class này sẽ bị ẩn đi */
      #delegateTable.an-cot-phu .cot-phu {
        display: none;
      }
    </style>
  </head>

  <body>
    <div class="container">
      <h1>DANH SÁCH ĐẠI BIỂU CHÍNH THỨC</h1>
      <h2>ĐẠI HỘI ĐẠI BIỂU ĐẢNG BỘ TỈNH THÁI NGUYÊN</h2>
      <h2>NHIỆM KỲ 2025 - 2030</h2>

      <div id="filter-tabs"></div>

      <input
        type="text"
        id="searchBox"
        onkeyup="filterTable()"
        placeholder="Nhập tên đại biểu hoặc đơn vị để tìm kiếm..."
      />

      <table id="delegateTable">
        <thead>
          <tr>
            <th rowspan="2">STT</th>
            <th rowspan="2">Họ và Tên</th>
            <th rowspan="2">Đơn vị</th>
            <th colspan="2">Vị trí chỗ ngồi</th>
            <!-- ✅ ĐÃ XÓA CỘT "TỔ THẢO LUẬN" -->
            <th rowspan="2" class="cot-phu">Tên khách sạn</th>
            <th rowspan="2" class="cot-phu">Số phòng</th>
          </tr>
          <tr>
            <th>Phiên khai mạc</th>
            <th>Phiên khác</th>
          </tr>
        </thead>
        <tbody id="tableBody">
          <tr>
            <!-- ✅ CẬP NHẬT COLSPAN TỪ 8 XUỐNG 7 -->
            <td colspan="7" style="text-align: center">Đang tải dữ liệu...</td>
          </tr>
        </tbody>
      </table>
    </div>

    <script>
      // Biến toàn cục để lưu trữ danh sách đại biểu
      let allDelegates = [];
      const table = document.getElementById("delegateTable");
      const tableBody = document.getElementById("tableBody");
      const tabsContainer = document.getElementById("filter-tabs");

      /**
       * Hàm chính để bắt đầu chạy logic của trang
       */
      function initializeApp() {
        // 1. KIỂM TRA CACHE TRÌNH DUYỆT TRƯỚC TIÊN
        const cachedDataString = sessionStorage.getItem("daiHoiData");

        if (cachedDataString) {
          // 2. NẾU CÓ DỮ LIỆU: Lấy dữ liệu từ cache, không cần gọi API
          console.log("Tìm thấy dữ liệu trong sessionStorage. Đang xử lý...");
          const fullData = JSON.parse(cachedDataString);

          // Trang này chỉ cần danh sách đại biểu chính thức
          if (fullData && fullData.officialDelegates) {
            renderPage(fullData.officialDelegates);
          } else {
            // Nếu cache có nhưng không có dữ liệu đại biểu, thì mới gọi API
            console.warn(
              "Cache có nhưng thiếu dữ liệu đại biểu. Đang gọi API dự phòng..."
            );
            fetchData();
          }
        } else {
          // 3. NẾU KHÔNG CÓ DỮ LIỆU: Gọi API như bình thường (phương án dự phòng)
          console.log(
            "Không tìm thấy dữ liệu trong sessionStorage. Đang gọi API..."
          );
          fetchData();
        }
      }

      /**
       * Hàm chịu trách nhiệm gọi API để lấy dữ liệu
       */
      function fetchData() {
        const apiUrl =
          "https://script.google.com/macros/s/AKfycbyRmKLSovYomChGDJB_OcNGOM8kDEfJ5Xs79Eplki0YAVMlRc5vOxKdHs5Pd5wgjiIe0w/exec?type=daibieu";
        // ✅ CẬP NHẬT COLSPAN TỪ 8 XUỐNG 7
        const initialColspan = 7;

        fetch(apiUrl)
          .then((response) => {
            if (!response.ok)
              throw new Error("Lỗi mạng hoặc không gọi được API");
            return response.json();
          })
          .then((data) => {
            if (data && data.delegates) {
              renderPage(data.delegates);
            } else {
              tableBody.innerHTML = `<tr><td colspan="${initialColspan}" style="text-align:center; color:red;">Dữ liệu nhận được không đúng định dạng.</td></tr>`;
            }
          })
          .catch((error) => {
            console.error("Lỗi khi tải dữ liệu:", error);
            tableBody.innerHTML = `<tr><td colspan="${initialColspan}" style="text-align:center; color:red;">Không thể tải dữ liệu. Vui lòng kiểm tra lại URL hoặc cài đặt API.</td></tr>`;
          });
      }

      /**
       * Hàm chịu trách nhiệm hiển thị toàn bộ nội dung trang sau khi có dữ liệu
       * @param {Array} delegatesData - Mảng chứa danh sách đại biểu
       */
      function renderPage(delegatesData) {
        allDelegates = delegatesData;
        createFilterTabs();
        displayDelegates("Tất cả");
        console.log("Trang đã được hiển thị thành công với dữ liệu.");
      }

      // --- CÁC HÀM TIỆN ÍCH ---

      function createFilterTabs() {
        const priorityOrder = [
          "Thường trực Tỉnh ủy",
          "Ủy viên BTV Tỉnh ủy",
          "Đảng bộ các cơ quan Đảng tỉnh",
          "Đảng bộ UBND tỉnh",
          "Đảng bộ Công an",
          "Đảng bộ Quân sự",
          "Xã, phường 1",
          "Xã, phường 2",
          "Xã, phường 3",
          "Xã, phường 4",
        ];
        const uniqueMainGroups = [
          ...new Set(
            allDelegates
              .map((d) => {
                if (d.nhomDonVi) {
                  if (/[AB]$/.test(d.nhomDonVi))
                    return d.nhomDonVi.slice(0, -1);
                  return d.nhomDonVi;
                }
                return null;
              })
              .filter(Boolean)
          ),
        ];

        uniqueMainGroups.sort((a, b) => {
          const indexA = priorityOrder.indexOf(a),
            indexB = priorityOrder.indexOf(b);
          const effectiveIndexA = indexA === -1 ? Infinity : indexA;
          const effectiveIndexB = indexB === -1 ? Infinity : indexB;
          if (effectiveIndexA !== effectiveIndexB)
            return effectiveIndexA - effectiveIndexB;
          return a.localeCompare(b, "vi");
        });

        tabsContainer.innerHTML = "";
        const allButton = document.createElement("button");
        allButton.className = "filter-btn active";
        allButton.innerText = "Tất cả";
        allButton.onclick = () => displayDelegates("Tất cả");
        tabsContainer.appendChild(allButton);

        uniqueMainGroups.forEach((unit) => {
          const unitButton = document.createElement("button");
          unitButton.className = "filter-btn";
          unitButton.innerText = unit;
          unitButton.onclick = () => displayDelegates(unit);
          tabsContainer.appendChild(unitButton);
        });
      }

      function displayDelegates(unitFilter) {
        const groupsToHideFor = ["Thường trực Tỉnh ủy", "Ủy viên BTV Tỉnh ủy"];
        const shouldHideColumns = groupsToHideFor.includes(unitFilter);
        table.classList.toggle("an-cot-phu", shouldHideColumns);

        // ✅ CẬP NHẬT COLSPAN TỪ 6, 8 THÀNH 5, 7
        const colspanValue = shouldHideColumns ? 5 : 7;
        tableBody.innerHTML = "";

        const delegatesToDisplay =
          unitFilter === "Tất cả"
            ? allDelegates
            : allDelegates.filter(
                (d) => d.nhomDonVi && d.nhomDonVi.startsWith(unitFilter)
              );

        document
          .querySelectorAll(".filter-btn")
          .forEach((btn) =>
            btn.classList.toggle("active", btn.innerText === unitFilter)
          );

        if (delegatesToDisplay.length === 0) {
          tableBody.innerHTML = `<tr><td colspan="${colspanValue}" style="text-align:center;">Không có đại biểu nào.</td></tr>`;
          return;
        }

        delegatesToDisplay.forEach((delegate, index) => {
          const sttDisplay = unitFilter === "Tất cả" ? delegate.stt : index + 1;
          const newRow = document.createElement("tr");
          // ✅ ĐÃ XÓA DÒNG HIỂN THỊ "TỔ THẢO LUẬN"
          newRow.innerHTML = `
                <td class="text-center">${sttDisplay}</td>
                <td>${delegate.hoTen}</td>
                <td>${delegate.donVi}</td>
                <td class="text-center">${delegate.viTriKhaiMac || ""}</td>
                <td class="text-center">${delegate.viTriPhienKhac || ""}</td>
                <td class="cot-phu">${delegate.khachSan || ""}</td>
                <td class="cot-phu text-center">${delegate.soPhong || ""}</td>
              `;
          tableBody.appendChild(newRow);
        });
        document.getElementById("searchBox").value = "";
        filterTable();
      }

      function filterTable() {
        const input = document.getElementById("searchBox"),
          filter = input.value.toUpperCase(),
          tr = tableBody.getElementsByTagName("tr");
        for (let i = 0; i < tr.length; i++) {
          const tdName = tr[i].getElementsByTagName("td")[1],
            tdUnit = tr[i].getElementsByTagName("td")[2];
          if (tdName || tdUnit) {
            const nameText = tdName.textContent || tdName.innerText,
              unitText = tdUnit.textContent || tdUnit.innerText;
            if (
              nameText.toUpperCase().indexOf(filter) > -1 ||
              unitText.toUpperCase().indexOf(filter) > -1
            ) {
              tr[i].style.display = "";
            } else {
              tr[i].style.display = "none";
            }
          }
        }
      }

      // --- BẮT ĐẦU CHẠY ỨNG DỤNG ---
      initializeApp();
    </script>

    <a href="../index.html" class="home-button" title="Về Trang chủ">
      <svg
        xmlns="http://www.w3.org/2000/svg"
        viewBox="0 0 24 24"
        fill="currentColor"
        width="24"
        height="24"
      >
        <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8h5z" />
      </svg>
      <span>Về Trang chủ</span>
    </a>
  </body>
</html>
