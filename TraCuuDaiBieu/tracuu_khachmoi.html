<!DOCTYPE html>
<html lang="vi">
  <head>
    <link rel="icon" type="image/png" href="/images/Codang.png" />
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Tra cứu Khách mời</title>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <div class="container">
      <h1>DANH SÁCH ĐẠI BIỂU MỜI</h1>
      <h2>ĐẠI HỘI ĐẠI BIỂU ĐẢNG BỘ TỈNH THÁI NGUYÊN</h2>
      <h2>NHIỆM KỲ 2025 - 2030</h2>
      <div id="filter-tabs"></div>
      <div class="search-container">
        <input
          type="text"
          id="searchBox"
          onkeyup="filterTable()"
          placeholder="Nhập tên khách mời hoặc chức vụ để tìm kiếm..."
        />
        <button
          id="viewSeatsBtn"
          class="view-btn"
          title="Xem vị trí của khách mời trong danh sách"
        >
          Vị trí chỗ ngồi
        </button>
      </div>

      <table id="delegateTable">
        <thead>
          <tr>
            <th rowspan="2">STT</th>
            <th rowspan="2">Họ và Tên</th>
            <th rowspan="2">Chức vụ, đơn vị công tác</th>
            <th colspan="2">Vị trí chỗ ngồi</th>
            <th rowspan="2">Tên khách sạn</th>
            <th rowspan="2">Số phòng</th>
          </tr>
          <tr>
            <th>Phiên khai mạc</th>
            <th>Phiên khác</th>
          </tr>
        </thead>
        <tbody id="tableBody">
          <tr>
            <td colspan="7" style="text-align: center">Đang tải dữ liệu...</td>
          </tr>
        </tbody>
      </table>
    </div>

    <script>
      // Biến toàn cục để lưu trữ danh sách khách mời
      let allDelegates = [];
      const tableBody = document.getElementById("tableBody");
      const tabsContainer = document.getElementById("filter-tabs");

      /**
       * Hàm chính để bắt đầu chạy logic của trang
       */
      function initializeApp() {
        // 1. KIỂM TRA CACHE TRÌNH DUYỆT TRƯỚC TIÊN
        const cachedDataString = sessionStorage.getItem("daiHoiData");

        if (cachedDataString) {
          // 2. NẾU CÓ DỮ LIỆU: Lấy dữ liệu từ cache
          console.log("Tìm thấy dữ liệu trong sessionStorage. Đang xử lý...");
          const fullData = JSON.parse(cachedDataString);

          // ✅ KHÁC BIỆT CHÍNH: Lấy danh sách khách mời (guestDelegates)
          if (fullData && fullData.guestDelegates) {
            renderPage(fullData.guestDelegates);
          } else {
            console.warn(
              "Cache có nhưng thiếu dữ liệu khách mời. Đang gọi API dự phòng..."
            );
            fetchData();
          }
        } else {
          // 3. NẾU KHÔNG CÓ DỮ LIỆU: Gọi API như bình thường (phương án dự phòng)
          console.log(
            "Không tìm thấy dữ liệu trong sessionStorage. Đang gọi API..."
          );
          fetchData();
        }
      }

      /**
       * Hàm chịu trách nhiệm gọi API để lấy dữ liệu (khi cache không có)
       */
      function fetchData() {
        const apiUrl =
          "https://script.google.com/macros/s/AKfycbyRmKLSovYomChGDJB_OcNGOM8kDEfJ5Xs79Eplki0YAVMlRc5vOxKdHs5Pd5wgjiIe0w/exec?type=khachmoi";
        const initialColspan = 7; // Dùng cho thông báo lỗi

        fetch(apiUrl)
          .then((response) => {
            if (!response.ok) {
              throw new Error("Lỗi mạng hoặc không gọi được API");
            }
            return response.json();
          })
          .then((data) => {
            if (data && data.delegates) {
              renderPage(data.delegates);
            } else {
              tableBody.innerHTML = `<tr><td colspan="${initialColspan}" style="text-align:center; color:red;">Dữ liệu nhận được không đúng định dạng.</td></tr>`;
            }
          })
          .catch((error) => {
            console.error("Lỗi khi tải dữ liệu:", error);
            tableBody.innerHTML = `<tr><td colspan="${initialColspan}" style="text-align:center; color:red;">Không thể tải dữ liệu. Vui lòng kiểm tra lại URL hoặc cài đặt API.</td></tr>`;
          });
      }

      /**
       * Hàm chịu trách nhiệm hiển thị toàn bộ nội dung trang sau khi có dữ liệu
       * @param {Array} delegatesData - Mảng chứa danh sách khách mời
       */
      function renderPage(delegatesData) {
        allDelegates = delegatesData;
        createFilterTabs();
        displayDelegates("Tất cả");
        console.log("Trang đã được hiển thị thành công với dữ liệu.");
      }

      // --- CÁC HÀM TIỆN ÍCH (giữ nguyên, không cần sửa) ---

      function createFilterTabs() {
        const priorityOrder = [
          "Đại biểu Trung ương, tỉnh bạn",
          "Nguyên Thường trực TU",
          "Nguyên Ủy viên BTV",
          "Nguyên lãnh đạo tỉnh",
          "Anh hùng, Mẹ VNAH",
        ];
        const uniqueUnits = [
          ...new Set(
            allDelegates
              .map((d) => {
                if (!d.donVi) return null;
                if (d.donVi.startsWith("Nguyên Ủy viên BTV")) {
                  return "Nguyên Ủy viên BTV";
                }
                return d.donVi;
              })
              .filter(Boolean)
          ),
        ];

        uniqueUnits.sort((a, b) => {
          const indexA = priorityOrder.indexOf(a),
            indexB = priorityOrder.indexOf(b);
          const effectiveIndexA = indexA === -1 ? Infinity : indexA;
          const effectiveIndexB = indexB === -1 ? Infinity : indexB;
          if (effectiveIndexA !== effectiveIndexB) {
            return effectiveIndexA - effectiveIndexB;
          }
          return a.localeCompare(b, "vi");
        });

        tabsContainer.innerHTML = "";
        const allButton = document.createElement("button");
        allButton.className = "filter-btn active";
        allButton.innerText = "Tất cả";
        allButton.onclick = () => displayDelegates("Tất cả");
        tabsContainer.appendChild(allButton);

        uniqueUnits.forEach((unit) => {
          const unitButton = document.createElement("button");
          unitButton.className = "filter-btn";
          unitButton.innerText = unit;
          unitButton.onclick = () => displayDelegates(unit);
          tabsContainer.appendChild(unitButton);
        });
      }

      function displayDelegates(unitFilter) {
        tableBody.innerHTML = "";
        const delegatesToDisplay =
          unitFilter === "Tất cả"
            ? allDelegates
            : allDelegates.filter(
                (d) => d.donVi && d.donVi.startsWith(unitFilter)
              );
        document
          .querySelectorAll(".filter-btn")
          .forEach((btn) =>
            btn.classList.toggle("active", btn.innerText === unitFilter)
          );

        if (delegatesToDisplay.length === 0) {
          tableBody.innerHTML = `<tr><td colspan="7" style="text-align:center;">Không có khách mời nào.</td></tr>`;
          return;
        }

        delegatesToDisplay.forEach((delegate, index) => {
          const sttDisplay = unitFilter === "Tất cả" ? delegate.stt : index + 1;
          const newRow = document.createElement("tr");
          newRow.innerHTML = `
                <td class="text-center">${sttDisplay}</td>
                <td>${delegate.hoTen}</td>
                <td>${delegate.chucVu || ""}</td>
                <td class="text-center">${delegate.viTriKhaiMac || ""}</td>
                <td class="text-center">${delegate.viTriPhienKhac || ""}</td>
                <td>${delegate.khachSan || ""}</td>
                <td class="text-center">${delegate.soPhong || ""}</td>
            `;
          tableBody.appendChild(newRow);
        });
        document.getElementById("searchBox").value = "";
        filterTable();
      }

      function filterTable() {
        const input = document.getElementById("searchBox"),
          filter = input.value.toUpperCase(),
          tr = tableBody.getElementsByTagName("tr");
        for (let i = 0; i < tr.length; i++) {
          const tdName = tr[i].getElementsByTagName("td")[1],
            tdChucVu = tr[i].getElementsByTagName("td")[2];
          if (tdName || tdChucVu) {
            const nameText = tdName.textContent || tdName.innerText,
              chucVuText = tdChucVu.textContent || tdChucVu.innerText;
            if (
              nameText.toUpperCase().indexOf(filter) > -1 ||
              chucVuText.toUpperCase().indexOf(filter) > -1
            ) {
              tr[i].style.display = "";
            } else {
              tr[i].style.display = "none";
            }
          }
        }
      }
      // ... sau khi kết thúc hàm filterTable()

      /**
       * Chuẩn hóa mã ghế từ dạng 'B15', 'V112' sang 'B-15', 'V1-12'
       */
      function normalizeSeatCode(code) {
        if (!code || typeof code !== "string") return null;
        let normalized = code.trim().toUpperCase();
        if (normalized.includes("-")) {
          return normalized;
        }
        if (normalized.startsWith("V1") || normalized.startsWith("V2")) {
          const prefix = normalized.substring(0, 2);
          const number = normalized.substring(2);
          return `${prefix}-${number}`;
        }
        const firstChar = normalized.charAt(0);
        if (firstChar >= "A" && firstChar <= "Z") {
          const number = normalized.substring(1);
          return `${firstChar}-${number}`;
        }
        return normalized;
      }
      /**
       * Hàm xử lý việc xem vị trí cho khách mời (chỉ dự phiên khai mạc)
       */
      /**
       * Hàm xử lý việc xem vị trí cho khách mời (chỉ dự phiên khai mạc)
       */
      function handleViewSeatsClick() {
        const trs = tableBody.getElementsByTagName("tr");
        const visibleSeats = new Set();
        const columnIndex = 3;

        for (let i = 0; i < trs.length; i++) {
          if (trs[i].style.display !== "none") {
            const seatCodeRaw =
              trs[i].getElementsByTagName("td")[columnIndex]?.innerText;
            const seatCodeNormalized = normalizeSeatCode(seatCodeRaw);
            if (seatCodeNormalized) {
              visibleSeats.add(seatCodeNormalized);
            }
          }
        }

        if (visibleSeats.size === 0) {
          alert("Không có vị trí nào trong danh sách để xem.");
          return;
        }

        const seatsQueryParam = Array.from(visibleSeats).join(",");

        // ✅ THAY ĐỔI: Thêm &type=khachmoi vào cuối URL
        const destinationUrl = `../ViTriChoNgoi/vitridaibieu.html?seats=${encodeURIComponent(
          seatsQueryParam
        )}&view=khaiMac&type=khachmoi`;

        window.location.href = destinationUrl;
      }
      // --- BẮT ĐẦU CHẠY ỨNG DỤNG ---
      initializeApp();
      document
        .getElementById("viewSeatsBtn")
        .addEventListener("click", handleViewSeatsClick);
    </script>

    <a href="../index.html" class="home-button" title="Về Trang chủ">
      <svg
        xmlns="http://www.w3.org/2000/svg"
        viewBox="0 0 24 24"
        fill="currentColor"
        width="24"
        height="24"
      >
        <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8h5z" />
      </svg>
      <span>Về Trang chủ</span>
    </a>
  </body>
</html>
