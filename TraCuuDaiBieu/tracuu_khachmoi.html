<!DOCTYPE html>
<html lang="vi">
<head>
      <link rel="icon" type="image/png" href="/images/Codang.png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tra cứu Khách mời</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <h1>DANH SÁCH ĐẠI BIỂU MỜI</h1>
        <h2>ĐẠI HỘI ĐẠI BIỂU ĐẢNG BỘ TỈNH THÁI NGUYÊN</h2>
        <h2>NHIỆM KỲ 2025 - 2030</h2>
        <div id="filter-tabs"></div>
        <input type="text" id="searchBox" onkeyup="filterTable()" placeholder="Nhập tên khách mời hoặc chức vụ để tìm kiếm...">

        <table id="delegateTable">
            <thead>
                <tr>
                    <th rowspan="2">STT</th>
                    <th rowspan="2">Họ và Tên</th>
                    <th rowspan="2">Chức vụ, đơn vị công tác</th>
                    <th colspan="2">Vị trí chỗ ngồi</th>
                    <th rowspan="2">Tên khách sạn</th>
                    <th rowspan="2">Số phòng</th>
                </tr>
                <tr>
                    <th>Phiên khai mạc</th>
                    <th>Phiên khác</th>
                </tr>
            </thead>
            <tbody id="tableBody">
                <tr><td colspan="7" style="text-align:center;">Đang tải dữ liệu...</td></tr>
            </tbody>
        </table>
    </div>

    <script>
        const apiUrl = 'https://script.google.com/macros/s/AKfycbxtztCEyEd0OIbY6dSQ_iZlQVcT0QONi0I71Vvh3Pd5hXGdA69tzpTA6SnjmNEpc8zCKA/exec?type=khachmoi';

        let allDelegates = [];
        const tableBody = document.getElementById('tableBody');
        const tabsContainer = document.getElementById('filter-tabs');

        function createFilterTabs() {
            const priorityOrder = [
                'Đại biểu Trung ương, tỉnh bạn',
                'Nguyên Thường trực TU',
                "Nguyên Ủy viên BTV", // Tên nhóm chung để lọc
                'Nguyên lãnh đạo tỉnh', // Tên này có thể cần sửa lại nếu trong sheet khác
                'Anh hùng, Mẹ VNAH'
            ];

            // ✅ LOGIC MỚI: Gộp các nhóm "Nguyên Ủy viên BTV - ..." vào nhóm chung
            const uniqueUnits = [...new Set(
                allDelegates.map(d => {
                    if (!d.donVi) return null;

                    // Nếu đơn vị bắt đầu bằng "Nguyên Ủy viên BTV", gộp thành một nhóm
                    if (d.donVi.startsWith('Nguyên Ủy viên BTV')) {
                        return 'Nguyên Ủy viên BTV';
                    }
                    // Giữ nguyên các đơn vị khác
                    return d.donVi;
                }).filter(Boolean)
            )];

            uniqueUnits.sort((a, b) => {
                const indexA = priorityOrder.indexOf(a);
                const indexB = priorityOrder.indexOf(b);
                const effectiveIndexA = indexA === -1 ? Infinity : indexA;
                const effectiveIndexB = indexB === -1 ? Infinity : indexB;
                if (effectiveIndexA !== effectiveIndexB) { return effectiveIndexA - effectiveIndexB; }
                return a.localeCompare(b, 'vi');
            });

            tabsContainer.innerHTML = '';
            const allButton = document.createElement('button');
            allButton.className = 'filter-btn active';
            allButton.innerText = 'Tất cả';
            allButton.onclick = () => displayDelegates('Tất cả');
            tabsContainer.appendChild(allButton);

            uniqueUnits.forEach(unit => {
                const unitButton = document.createElement('button');
                unitButton.className = 'filter-btn';
                unitButton.innerText = unit;
                unitButton.onclick = () => displayDelegates(unit);
                tabsContainer.appendChild(unitButton);
            });
        }

        function displayDelegates(unitFilter) {
            tableBody.innerHTML = '';

            // ✅ LOGIC MỚI: Lọc theo tên nhóm chung
            const delegatesToDisplay = unitFilter === 'Tất cả'
                ? allDelegates
                // Sửa lại logic lọc để dùng startsWith cho trường hợp nhóm gộp
                : allDelegates.filter(d => d.donVi && d.donVi.startsWith(unitFilter));

            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.toggle('active', btn.innerText === unitFilter);
            });

            if (delegatesToDisplay.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="7" style="text-align:center;">Không có khách mời nào.</td></tr>`;
                return;
            }

            delegatesToDisplay.forEach((delegate, index) => {
                const sttDisplay = (unitFilter === 'Tất cả') ? delegate.stt : index + 1;
                const newRow = document.createElement('tr');
                newRow.innerHTML = `
                        <td class="text-center">${sttDisplay}</td>
                        <td>${delegate.hoTen}</td>
                        <td>${delegate.chucVu || ''}</td>
                        <td class="text-center">${delegate.viTriKhaiMac || ''}</td>
                        <td class="text-center">${delegate.viTriPhienKhac || ''}</td>
                        <td>${delegate.khachSan || ''}</td>
                        <td class="text-center">${delegate.soPhong || ''}</td>
                    `;
                tableBody.appendChild(newRow);
            });

            document.getElementById('searchBox').value = '';
            filterTable();
        }
        function filterTable() {
            const input = document.getElementById("searchBox");
            const filter = input.value.toUpperCase();
            const tr = tableBody.getElementsByTagName("tr");
            for (let i = 0; i < tr.length; i++) {
                const tdName = tr[i].getElementsByTagName("td")[1];
                const tdChucVu = tr[i].getElementsByTagName("td")[2];

                if (tdName || tdChucVu) {
                    const nameText = (tdName.textContent || tdName.innerText);
                    const chucVuText = (tdChucVu.textContent || tdChucVu.innerText);
                    if (nameText.toUpperCase().indexOf(filter) > -1 || chucVuText.toUpperCase().indexOf(filter) > -1) {
                        tr[i].style.display = "";
                    } else {
                        tr[i].style.display = "none";
                    }
                }
            }
        }

        fetch(apiUrl)
            .then(response => { if (!response.ok) { throw new Error('Lỗi mạng hoặc không gọi được API'); } return response.json(); })
            .then(data => {
                if (data && data.delegates) {
                    allDelegates = data.delegates;
                    createFilterTabs();
                    displayDelegates('Tất cả');
                } else {
                    // THAY ĐỔI: Cập nhật colspan từ 5 thành 7
                    tableBody.innerHTML = `<tr><td colspan="7" style="text-align:center; color:red;">Dữ liệu nhận được không đúng định dạng.</td></tr>`;
                }
            })
            .catch(error => {
                console.error('Lỗi khi tải dữ liệu:', error);
                // THAY ĐỔI: Cập nhật colspan từ 5 thành 7
                tableBody.innerHTML = `<tr><td colspan="7" style="text-align:center; color:red;">Không thể tải dữ liệu. Vui lòng kiểm tra lại URL hoặc cài đặt API.</td></tr>`;
            });
    </script>
    <a href="../index.html" class="home-button" title="Về Trang chủ">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="24" height="24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8h5z"/></svg>
        <span>Về Trang chủ</span>
    </a>
</body>
</html>